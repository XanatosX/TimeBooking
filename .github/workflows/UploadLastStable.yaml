name: Create Linux build artifacts (amd64)

on: push

jobs:
   buildLinux:
     name: Create Linux artifact
     runs-on: ubuntu-latest
     steps:
       - name: Clone repository
         uses: actions/checkout@v2
       - name: Create build
         run: |
          sudo npm install -g electron-installer-debian
          npm install
          npm run build:linux
       - name: Create installers
         run: |
           npm run setup:deb
       - name: Create zips
         run: |
          npm run zip:linux
       - name: Cleanup artifact
         run: | 
          mkdir upload-artifacts/
          mv dist/zips/* upload-artifacts
          mv dist/installers/linux/* upload-artifacts
       - name: Archive production artifacts
         uses: actions/upload-artifact@v2
         with:
          name: LinuxArtifacts
          path: |
            upload-artifacts/
   buildWindows:
     name: Create Windows artifact
     runs-on: windows-latest
     steps:
       - name: Clone repository
         uses: actions/checkout@v2
       - name: Create build
         run: |
          npm install
          npm run build:win32
          npm run build:win64
       - name: Create installers
         run: |
           npm run setup:win32
           npm run setup:win64
       - name: Create zips
         run: |
          npm run zip:win32
          npm run zip:win64
       - name: Cleanup artifact
         run: |
          mkdir upload-artifacts/
          move dist/zips/* upload-artifacts
          move dist/installers/win32/*.exe upload-artifacts
          move dist/installers/win64/*.exe upload-artifacts
       - name: Archive production artifacts
         uses: actions/upload-artifact@v2
         with:
          name: WindowsArtifacts
          path: |
           upload-artifacts
   createUploadArtifact:
     name: Upload releases
     #needs: ["buildLinux", "buildWindows"]
     needs: ["buildLinux"]
     runs-on: ubuntu-latest
     steps:
       - name: Download artifacts
         uses: actions/download-artifact@v2
         with:
           path: dist
       - name: Prepare upload folder
         run: |
          mkdir artifact-upload/
          mv dist/LinuxArtifacts/* artifact-upload/
       - name: List upload data
         run: ls -la artifact-upload
       - name: Archive production artifacts
         uses: actions/upload-artifact@v2
         with:
          name: buildArtifacts
          path: |
           artifact-upload
   createLatestBuild:
      name: Latest unstable build
      needs: ["createUploadArtifact"]
      runs-on: ubuntu-latest
      steps:
        - name: Download artifacts
          uses: actions/download-artifact@v2
          with:
            name: buildArtifacts
            path: dist/
        - name: Create Release
          id: create_release
          uses: actions/create-release@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            tag_name: ${{ github.ref }}-${{ GITHUB.RUN_NUMBER }}
            release_name: Latest unstable
            body: This is the latest build version
            draft: true
            prerelease: true
        - name: Upload linux zip
          id: upload-linux-zip
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: dist/artifact-upload\TimeBooking-linux-x64.zip
            asset_name: Latest_TimeBooking-linux-x64.zip
            asset_content_type: application/zip
        - name: Upload linux deb
          id: upload-linux-deb
          uses: actions/upload-release-asset@v1
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: dist/artifact-upload\timebooking_0.0.1_amd64.deb
            asset_name: timebooking_0.0.1_amd64.deb
            asset_content_type: application/vnd.debian.binary-package